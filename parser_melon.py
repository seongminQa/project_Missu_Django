import requests
from bs4 import BeautifulSoup
import json
import os
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
import re
import django
django.setup()

from music.models import MelonWeekTop

def parse_music():
  header = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
  req = requests.get('https://www.melon.com/chart/week/index.htm',headers = header)
  soup = BeautifulSoup(req.content,'html.parser')
  meloncharts = soup.select('table > tbody > tr')
  
  data = []
  # data = {}
  for idx, melonchart in enumerate(meloncharts):
    # 순위
    rank = melonchart.select('div.wrap.t_center > span.rank ')[0].text
    # 앨범표지
    image = 'melon/melon{}.jpg'.format((idx+1))
    # 가수
    musician = melonchart.select('div.ellipsis.rank02 > span > a')[0].text
    # 곡 제목 찾기
    title = melonchart.select('div.ellipsis.rank01 > span > a')[0].text
    # 앨범
    album = melonchart.select('div.ellipsis.rank03 > a')[0].text
    album_link = melonchart.select_one('div.ellipsis.rank03 > a').attrs["href"]
    p = re.compile('[0-9]+')
    album_id = p.findall(album_link)    
    # https://www.melon.com/album/music.htm?albumId=album_id[0]
    
    req = requests.get(f'https://www.melon.com/album/music.htm?albumId={album_id[0]}',headers = header)
    soup1 = BeautifulSoup(req.content,'html.parser')
    album_info = soup1.select("#conts > div.section_info > div > div.entry > div.meta > dl.list")
    for album_info in album_info:
    # #conts > div.section_info > div > div.entry > div.meta > dl > dd:nth-child(2)
      released_at = album_info.select("dd:nth-child(2)")[0].text
      genre = album_info.select('dd:nth-child(4)')[0].text
      released_cop = album_info.select('dd:nth-child(6)')[0].text
      planned_cop = album_info.select('dd:nth-child(8)')[0].text



    # data.append([rank,image,title,musician,album,album_link])
    data.append([rank,image,title,musician,album,released_at,genre,released_cop,planned_cop])

  return data 

if __name__=='__main__':
  melon_data_dict = parse_music()

  for rank,image, title, musician, album,released_at,genre,released_cop,planned_cop in melon_data_dict:
    MelonWeekTop(rank=rank,image=image, title=title,musician=musician,album=album,released_at=released_at,genre=genre,released_cop=released_cop,planned_cop=planned_cop).save()

























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































