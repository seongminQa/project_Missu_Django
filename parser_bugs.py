import requests
from bs4 import BeautifulSoup
import json
import os
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")

import django
django.setup()

from music.models import BugsWeekTop

def parse_music():
  header = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
  req = requests.get('https://music.bugs.co.kr/chart/track/week/total',headers = header)
  soup = BeautifulSoup(req.content,'html.parser')
  bugscharts = soup.select('#CHARTweek > table > tbody > tr')
  
  data = []
  # data = {}
  for idx, bugschart in enumerate(bugscharts):
    # 순위
    rank = bugschart.select('td > div.ranking > strong')[0].text
    # 앨범표지
    image = 'Bugs/Bugs{}.jpg'.format((idx+1))
    # 가수
    title = bugschart.select('th > p.title > a')[0].text
    # 곡 제목 찾기
    musician = bugschart.select('td > p.artist > a')[0].text
    # 앨범
    album = bugschart.select('td > a.album')[0].text
    # 앨범 detail 정보
    album_link = bugschart.select_one('td > a.album').attrs['href']

    
    req1 = requests.get(album_link,headers = header)

    # 2차 크롤링
    soup1 = BeautifulSoup(req1.content,'html.parser')
    album_info = soup1.select("#container > section.sectionPadding.summaryInfo.summaryAlbum > div > div.basicInfo > table > tbody")
    for album_info in album_info:
        released_at = album_info.select("tr:nth-child(3) > td > time")[0].text
        genre = album_info.select('tr:nth-child(4) > td > a')[0].text
        released_cop = album_info.select('tr:nth-child(7) > td')[0].text
        planned_cop = album_info.select('tr:nth-child(6) > td')[0].text

        # 2차 크롤링 추가
        
    data.append([rank,image,title,musician,album,released_at,genre,released_cop,planned_cop])

  return data 

if __name__=='__main__':
  bugs_data_dict = parse_music()

  for rank,image, title, musician, album,released_at,genre,released_cop,planned_cop in bugs_data_dict:
    BugsWeekTop(rank=rank,image=image, title=title,musician=musician,album=album,released_at=released_at,genre=genre,released_cop=released_cop,planned_cop=planned_cop).save()

























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































