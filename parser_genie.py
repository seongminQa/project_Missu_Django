import requests
from bs4 import BeautifulSoup
import json
import os
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
import re
import django
django.setup()

from music.models import GeniWeekTop

def parse_music():
  header = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
  req = requests.get('https://www.genie.co.kr/chart/genre?ditc=W&ymd=20230123&genrecode=M0100&pg=1',headers = header)
  soup = BeautifulSoup(req.content,'html.parser')
  geniecharts = soup.select('table.list-wrap > tbody > tr')
  
  data = []
  # data = {}
  for idx, geniechart in enumerate(geniecharts,1):
    # 순위
    rank = idx
    # 앨범표지
    image = 'genie/genie{}.jpg'.format((idx))
    # 가수
    musician = geniechart.select('td.info > a.artist.ellipsis')[0].text
    # 곡 제목 찾기
    title = geniechart.select('td.info > a.title.ellipsis')[0].text
    # 앨범
    album = geniechart.select('td.info > a.albumtitle.ellipsis')[0].text
    album_link = geniechart.select_one('td.info > a.albumtitle.ellipsis').attrs["onclick"]

    p = re.compile('[0-9]+')
    album_id = p.findall(album_link)
    # album_id[0]
    req = requests.get(f'https://www.genie.co.kr/detail/albumInfo?axnm={album_id[0]}',headers = header)
    soup1 = BeautifulSoup(req.content,'html.parser')
    album_info = soup1.select("#body-content > div.album-detail-infos > div.info-zone > ul.info-data")

    for album_info in album_info:
    # #body-content > div.album-detail-infos > div.info-zone > ul > li:nth-child(2) > span.value
    # #body-content > div.album-detail-infos > div.info-zone > ul > li:nth-child(3) > span.value
    # #body-content > div.album-detail-infos > div.info-zone > ul > li:nth-child(4) > span.value
      genre = album_info.select('li:nth-child(2) > span.value')[0].text
      released_cop = album_info.select('li:nth-child(3) > span.value')[0].text
      planned_cop = album_info.select('li:nth-child(4) > span.value')[0].text
      released_at = album_info.select("li:nth-child(5) > span.value")[0].text
    # data.append([rank,image,title,musician,album,album_link])
    data.append([rank,image,title,musician,album,released_at,genre,released_cop,planned_cop])

  return data 

if __name__=='__main__':
  genie_data_dict = parse_music()

  for rank,image, title, musician, album,released_at,genre,released_cop,planned_cop in genie_data_dict:
    GeniWeekTop(rank=rank,image=image, title=title,musician=musician,album=album,released_at=released_at,genre=genre,released_cop=released_cop,planned_cop=planned_cop).save()

























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































